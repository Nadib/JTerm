var ShellUI=function(e,t,n){void 0===n&&(n={}),void 0===n.prefix&&(n.prefix="$"),void 0===n.highlightColor&&(n.highlightColor="#a5a5a5"),void 0===n.helpEnabled&&(n.helpEnabled=!0),void 0===n.language&&(n.language=navigator.language),void 0===n.failbackLanguage&&(n.failbackLanguage="en"),this.options=n,this.inputElement=e,this.outputElement=t,this.endlineElement=null,this.prefixElement=null,this.keyboardSelected=null,this.currentHistory=null,this.commandHistory=[],this.commands={},this.preventPaste=!1,this.controlPressed=!1,this.eventListeners={},this.language=this.options.language,this.failbackLanguage=this.options.failbackLanguage,this.init=function(){this.inputElement=document.getElementById(this.inputElement),this.inputElement.style["white-space"]="pre",document.addEventListener("dragover",function(e){e.preventDefault()},!1),document.addEventListener("drop",this.dropText.bind(this)),document.addEventListener("paste",this.pasteText.bind(this)),this.outputElement=document.getElementById(this.outputElement),this.outputElement.style["white-space"]="pre",this.endlineElement=this.createElement("span"," "),this.endlineElement.style["background-color"]=this.options.highlightColor,this.endlineElement.style["white-space"]="pre",this.endlineElement.style["padding-left"]="3px",this.inputElement.parentElement.insertBefore(this.endlineElement,this.inputElement.nextSibling),this.prefixElement=this.createElement("span",this.options.prefix+" "),this.inputElement.parentElement.insertBefore(this.prefixElement,this.inputElement),document.addEventListener("keypress",this.keyboardCallback.bind(this)),document.addEventListener("keydown",this.keyboardInteraction.bind(this)),document.addEventListener("keyup",this.keyboardUp.bind(this)),this.addEventListener("commandComplete",this.commandComplete.bind(this)),!0===this.options.helpEnabled&&this.addCommand("help",this.helpCommand.bind(this)),this.loadDependancy("languages/"+this.language+".js"),this.language!==this.failbackLanguage&&this.loadDependancy("languages/"+this.failbackLanguage+".js")},this.loadDependancy=function(e){var t=document.createElement("script");t.type="text/javascript",t.src=e,document.body.appendChild(t)},this.helpCommand=function(e){var t="";if(void 0===e){t=this.getMessage("command_list_title")+"\r\n\r\n";for(var n in this.commands)"help"!==n&&(t+=" - "+this.commands[n].getHelp(!0)+"\r\n");t+="\r\n "+this.getMessage("command_help")}else e&&(null===this.getCommand(e)?t+=this.getMessage("command_not_found").printf(e):t+=this.commands[e].getHelp());return t},this.getMessage=function(e,t){return void 0===t&&(t=this.language),ShellUILanguage[t]&&ShellUILanguage[t][e]?ShellUILanguage[t][e]:ShellUILanguage[this.failbackLanguage]&&ShellUILanguage[this.failbackLanguage][e]?ShellUILanguage[this.failbackLanguage][e]:void 0},this.removeEventListener=function(e,t){if(this.eventListeners[e]){var n;for(n=0;n<this.eventListeners[e].length;n++)if(this.eventListeners[e][n]===t){this.eventListeners[e].splice(n,1);break}}},this.addEventListener=function(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)},this.dispatchEvent=function(e){if(this.eventListeners[e.name]){var t;for(e.target=this,t=0;t<this.eventListeners[e.name].length;t++)this.eventListeners[e.name][t].apply(this,[e])}},this.dropText=function(e){e.preventDefault();var t="";if(e.dataTransfer.files.length>0){var n;for(n=0;n<e.dataTransfer.files.length;n++)n>0&&(t+=" "),t+=e.dataTransfer.files[n].name}else t=e.dataTransfer.getData("text");this.pasteText(t)},this.pasteText=function(e){var t="";t="string"==typeof e?e:e.clipboardData.getData("text");var n,i=this.inputElement.textContent,s="";for(n=0;n<t.length;n++)s+="<span>"+t[n]+"</span>";if(null!==this.keyboardSelected){var a="";for(n=0;n<i.length;n++)n===this.keyboardSelected&&(a+=s),a+="<span>"+i[n]+"</span>";this.inputElement.innerHTML=a,this.keyboardSelected=this.keyboardSelected+textData.length}else this.inputElement.innerHTML+=s},this.addCommand=function(e,t,n){this.commands[e]=new ShellUICommand(e,t,this,n)},this.getCommand=function(e){return this.commands[e]?this.commands[e]:null},this.executeCommand=function(e){var t=new ShellUICommandParser(e),n=this.getCommand(t.command);null===n?this.printOutput(this.getMessage("command_not_found").printf(commandName)):(this.prefixElement.style.display="none",n.execute(t.getArguments()))},this.commandComplete=function(e){e.options.returnContent&&this.printOutput(e.options.returnContent),this.resetInput(),this.prefixElement.style.display="inline"},this.resetInput=function(){for(this.selectChar(null);this.inputElement.firstChild;)this.inputElement.removeChild(this.inputElement.firstChild)},this.createElement=function(e,t){var n=document.createElement(e),i=document.createTextNode(t);return n.appendChild(i),n},this.keyboardCallback=function(e){switch(e.keyCode){case 8:case 37:case 39:case 38:case 40:break;case 13:var t=this.inputElement.textContent;this.printOutput(this.prefixElement.textContent+t),this.resetInput(),t&&(this.commandHistory.push(t),this.executeCommand(t)),this.outputElement.parentNode.scrollTop=this.outputElement.parentNode.scrollHeight,this.currentHistory=null;break;default:if(!e.key){var n=String.fromCharCode(e.keyCode);e.shiftKey||(n=n.toLowerCase()),e.key=n}if(!1===this.preventPaste){if(!0===this.controlPressed&&("c"===e.key||3===e.keyCode)){this.resetInput();var i=new ShellUIEvent("cancel",{});return void this.dispatchEvent(i)}null!==this.keyboardSelected?(this.inputElement.insertBefore(this.createElement("span",e.key),this.inputElement.children[this.keyboardSelected]),this.selectChar(this.keyboardSelected+1)):this.inputElement.append(this.createElement("span",e.key))}}},this.printOutput=function(e){this.outputElement.appendChild(this.createElement("p",e))},this.removeChar=function(e){-1===e&&(e=this.inputElement.children.length-1),this.inputElement.children[e]&&this.inputElement.removeChild(this.inputElement.children[e])},this.selectChar=function(e){null!==this.keyboardSelected&&this.inputElement.children[this.keyboardSelected]&&(this.inputElement.children[this.keyboardSelected].style["background-color"]="transparent"),this.keyboardSelected=e,null!==this.keyboardSelected&&this.inputElement.children[this.keyboardSelected]?(this.endlineElement.style.display="none",this.inputElement.children[this.keyboardSelected].style["background-color"]=this.options.highlightColor):this.endlineElement.style.display="inline"},this.repeatCommand=function(e){if(this.currentHistory=e,this.commandHistory[this.currentHistory]){this.resetInput();var t;for(t=0;t<this.commandHistory[this.currentHistory].length;t++)this.inputElement.appendChild(this.createElement("span",this.commandHistory[this.currentHistory][t]))}},this.selectFromKeyboard=function(e){length=this.inputElement.children.length,length>0&&("left"===e?null===this.keyboardSelected?this.selectChar(length-1):this.keyboardSelected>0&&this.selectChar(this.keyboardSelected-1):"right"===e&&(null!==this.keyboardSelected&&this.keyboardSelected<length-1?this.selectChar(this.keyboardSelected+1):this.selectChar(null)))},this.selectCommandFromHistory=function(e){length=this.commandHistory.length,length>0&&("top"===e?null===this.currentHistory?this.repeatCommand(length-1):this.currentHistory>0&&this.repeatCommand(this.currentHistory-1):"bottom"===e&&(null!==this.currentHistory&&this.currentHistory<length-1?this.repeatCommand(this.currentHistory+1):this.repeatCommand(null)))},this.keyboardUp=function(e){"Control"!=e.keyIdentifier&&"Control"!==e.key?(e.keyIdentifier&&"Meta"===e.keyIdentifier||e.key&&"Meta"===e.key)&&(this.preventPaste=!1):this.controlPressed=!1},this.keyboardInteraction=function(e){if(e.keyIdentifier&&"Meta"===e.keyIdentifier||e.key&&"Meta"===e.key)this.preventPaste=!0;else if("Control"!=e.keyIdentifier&&"Control"!==e.key)switch(e.keyCode){case 8:null!==this.keyboardSelected?this.keyboardSelected>0&&(this.removeChar(this.keyboardSelected-1),this.selectChar(this.keyboardSelected-1)):this.removeChar(-1);break;case 37:this.selectFromKeyboard("left");break;case 39:this.selectFromKeyboard("right");break;case 38:this.selectCommandFromHistory("top");break;case 40:this.selectCommandFromHistory("bottom")}else this.controlPressed=!0},"complete"===document.readyState?this.init():document.addEventListener("DOMContentLoaded",this.init.bind(this))},ShellUICommandParser=function(e){var t=e.match(/'[^']*'|"[^"]*"|\S+/g)||[];this.command=t[0],this.arguments=[];var n=1;for(n=1;n<t.length;n++)'"'===t[n][0]&&'"'===t[n][t[n].length-1]?(t[n]=t[n].substr(1),t[n]=t[n].substr(0,t[n].length-1)):"'"===t[n][0]&&"'"===t[n][t[n].length-1]&&(t[n]=t[n].substr(1),t[n]=t[n].substr(0,t[n].length-1)),this.arguments.push(t[n]);this.getArguments=function(){return this.arguments}},ShellUICommand=function(e,t,n,i){void 0===i&&(i={}),this.name=e,this.callback=t,this.shell=n,this.options=i,this.signature=null,this.cancel=!1,this.execute=function(arguments){this.cancel=!1,this.shell.removeEventListener("cancel",this.cancelBound),this.shell.addEventListener("cancel",this.cancelBound),!0===this.options.async?this.callback.apply(this,arguments):this.endCommand(this.callback.apply(this,arguments))},this.getSignature=function(){if(null===this.signature){this.signature=this.name;var e,t=this.getArguments();for(e=0;e<t.length;e++)this.signature+=" ["+t[e]+"]"}return this.signature},this.getArguments=function(){if(!this.arguments){this.arguments=[];var e,t=this.callback.toString().replace(/[\r\n\s]+/g," ").match(/function\s*\w*\s*\((.*?)\)/)[1].split(/\s*,\s*/);for(e=0;e<t.length;e++)this.arguments.push(" ["+t[e]+"]")}return this.arguments},this.endCommand=function(e){if(!1===this.cancel){var t=new ShellUIEvent("commandComplete",{returnContent:e,command:this});this.shell.dispatchEvent(t)}},this.getHelp=function(e){var t=this.getSignature();return this.options.summary&&(t+=" "+this.options.summary),!0===e?t:(this.options.help&&(t+=" \r\n"+this.options.help),t)},this.cancelCallback=function(e){this.cancel=!0;var t=new ShellUIEvent("commandComplete",{returnContent:void 0,command:this});this.shell.dispatchEvent(t)},this.cancelBound=this.cancelCallback.bind(this)},ShellUIEvent=function(e,t){this.name=e,this.options=t,this.target=null},ShellUILanguage={};String.prototype.printf=function(){var e=arguments,t=0;return this.replace(/(%s)/g,function(){return e[t++]})};